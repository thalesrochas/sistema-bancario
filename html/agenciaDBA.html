<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="../bootstrap/css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../style.css">
    
    <title>NullBank DBA - Agências</title>
</head>
<body>
    <!-- Abas da página -->
    <div>
        <div class="degrade">
            <div class="aui-group">
                <div class="aui-item">
                    <h1 class="nullbank">NullBank</h1>
                </div>
                <div class="aui-item">
                    <button id="desconectar" class="btn btn-outline-light btn-sm desconectar" onclick="onClickDesconectar()">
                        Encerrar Sessão
                        <img id="icon" src="../img/exit_to_app.png">
                    </button>
                </div>
            </div>
        </div>
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#">Agências</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="clickElement('funcionarioDBA')">Funcionários</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="clickElement('clienteDBA')">Clientes</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="clickElement('contaDBA')">Contas</a>
            </li>
        </ul>
    </div>
    
    <div class="aui-group">
        <!-- Coluna da tabela de Agências -->
        <div class="aui-item column-width">
            <div class="input-group padding16">
                <input id="pesquisa" type="text" oninput="pesquisar()" class="form-control" placeholder="Pesquisar..." autofocus>
                <span class="input-group-addon badge-info">
                    <img src="../img/search.png">
                </span>
            </div>
            <div class="table-padding">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Número</th>
                            <th scope="col">Nome</th>
                            <th scope="col">Cidade</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="table-padding-corpo" style="overflow:auto; height:423px">
                <table class="table table-hover">
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>
            <div class="padding16 center">
                <button class="btn btn-primary" onclick="adicionarAgencia()" disabled>
                    <img src="../img/account.png">
                    Nova Agência
                </button>
            </div>
        </div>
        
        <!-- Coluna das informações da Agência selecionada -->
        <div class="aui-item barra-vertical" style="padding-right:0; padding-top:0;">
            <div style="overflow:auto; height:562px; padding-right:16px; padding-top:16px">
                <div class="padding16 rounded border border-secondary">
                    <h5>Dados da Agência</h5>
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="numero">Número</label>
                            <input type="text" class="form-control" id="numero" disabled>
                        </div>
                        <div class="form-group col-md-9">
                            <label for="nome">Nome</label>
                            <input type="text" class="form-control" id="nome" disabled>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="gerente">Gerente</label>
                            <input type="text" class="form-control" id="gerente" disabled>
                        </div> 
                        <div class="form-group col-md-4">
                            <label for="salario">Salário Montante</label>
                            <div class="input-group">
                                <span class="input-group-addon">R$</span>
                                <input type="text" class="form-control" id="salario" disabled>
                            </div>
                        </div>
                        <div class="form-group col-md-5">
                            <label for="cidade">Cidade</label>
                            <input type="text" class="form-control" id="cidade" disabled>
                        </div>
                    </div>
                </div>
                <div class="padding16 margin-top16 rounded border border-secondary" id="funcionario">
                    <div class="form-row">
                        <h5 style="margin-right: 229px">Funcionários</h5>
                        <label style="margin-right: 10px">Ordenar por:</label>
                        <div class="btn-group btn-group-sm margin-bottom16">
                            <button class="btn btn-info" disabled>Nome</button>
                            <button class="btn btn-info" disabled>Salário</button>
                        </div>
                    </div>
                    <div class="padding16 margin-bottom16 rounded border border-info">
                        <div class="form-row">
                            <div class="form-group col-md-8">
                                <label>Nome</label>
                                <input class="form-control" disabled>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Cargo</label>
                                <input class="form-control" disabled>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-8">
                                <label>Endereço</label>
                                <input class="form-control" disabled>
                            </div> 
                            <div class="form-group col-md-4">
                                <label>Cidade</label>
                                <input class="form-control" disabled>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-5">
                                <label>Salário</label>
                                <div class="input-group">
                                    <span class="input-group-addon">R$</span>
                                    <input class="form-control" disabled>
                                </div>
                            </div>
                            <div class="form-group col-md-5">
                                <label>Número de Dependentes</label>
                                <input class="form-control" disabled>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="padding16 margin-top16 rounded border border-secondary">
                    <h5>Clientes</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Nome</th>
                                <th scope="col">Tipo de Conta</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCliente"></tbody>
                    </table>
                </div>
                <div class="padding16 margin-top16 rounded border border-secondary">
                    <h5>Contas Especiais com maior saldo devedor</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Número da Conta</th>
                                <th scope="col">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaContaEspecial"></tbody>
                    </table>
                </div>
                <div class="padding16 margin-top16 rounded border border-secondary">
                    <h5>Contas Poupança com maior saldo positivo</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Número da Conta</th>
                                <th scope="col">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaContaPoupanca"></tbody>
                    </table>
                </div>
                <div class="padding16 margin-top16 rounded border border-secondary">
                    <div class="form-row">
                        <h5 style="margin-right: 102px">Número de Transações</h5>
                        <label style="margin-right: 10px">Últimos:</label>
                        <div class="btn-group btn-group-sm margin-bottom16">
                            <button id="btnNum7" class="btn btn-info" onclick="onClickNumTrans(7)" disabled>7 dias</button>
                            <button id="btnNum30" class="btn btn-info" onclick="onClickNumTrans(30)" disabled>30 dias</button>
                            <button id="btnNum365" class="btn btn-info" onclick="onClickNumTrans(365)" disabled>365 dias</button>
                        </div>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Nº da Conta Corrente</th>
                                <th scope="col">Número de Transações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaNumTransacao"></tbody>
                    </table>
                </div>
                <div class="padding16 margin-top16 rounded border border-secondary">
                    <div class="form-row">
                        <h5 style="margin-right: 62px">Volume de Movimentações</h5>
                        <label style="margin-right: 10px">Últimos:</label>
                        <div class="btn-group btn-group-sm margin-bottom16">
                            <button id="btnVol7" class="btn btn-info" disabled>7 dias</button>
                            <button id="btnVol30"class="btn btn-info" disabled>30 dias</button>
                            <button id="btnVol365" class="btn btn-info" disabled>365 dias</button>
                        </div>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Número da Conta</th>
                                <th scope="col">Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVolTransacao"></tbody>
                    </table>
                </div>
            </div>
        
            <!-- Botões -->
            <div class="center margin-top16">
                <button onclick="onClickAtualizar(-1)" id="atualizar" class="btn btn-success" disabled>
                    <img src="../img/sync.png">
                    Atualizar
                </button>
                <button onclick="onClickDeletar(-1)" id="deletar" class="btn btn-danger" disabled>
                    <img src="../img/delete.png">
                    Remover
                </button>
            </div>
        </div>
    </div>

    <!-- Script de requisições de dados -->
    <script>
        const ipcRenderer = require('electron').ipcRenderer;

        // Quando a página carrega, os dados são requisitados
        ipcRenderer.send('requestData', 'agencia');
        
        // Evento ocorre quando os dados são enviados por main.js
        ipcRenderer.on('dataAgencia', function (event, dataAgencia) {
            let tbody = document.getElementById('corpoTabela');

            // Remove todos os elementos do corpo da tabela antes de inserir os novos
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            // Inserir os dados do banco na tabela
            dataAgencia.forEach(element => {
                let tr = document.createElement('tr');
                let th = document.createElement('th');
                let tdNome = document.createElement('td');
                let tdCidade = document.createElement('td');

                // Cria atributo de onclick com numero da agencia como parâmetro
                tr.setAttribute('onclick', 'selectAgencia(' + element.numero + ')');
                th.textContent = element.numero;
                tdNome.textContent = element.nome;
                tdCidade.textContent = element.cidade;

                tr.appendChild(th);
                tr.appendChild(tdNome);
                tr.appendChild(tdCidade);
                tbody.appendChild(tr);
            });
        });

        // Evento ocorre quando os dados requisitados retornam do main.js
        ipcRenderer.on('fieldsRequested', function (event, fields) {
            console.log(fields);

            let numero = document.getElementById('numero');
            let nome = document.getElementById('nome');
            let gerente = document.getElementById('gerente');
            let salario = document.getElementById('salario');
            let cidade = document.getElementById('cidade');
            
            numero.value = fields["0"].numero;
            nome.value = fields["0"].nome;
            gerente.value = fields["0"].mat_gerente;
            salario.value = fields["0"].salario_montante;
            cidade.value = fields["0"].cidade;

            // Remover os atributos de desabilitado dos botões de numero de transações e volume
            let btnNum7 = document.getElementById('btnNum7');
            let btnNum30 = document.getElementById('btnNum30');
            let btnNum365 = document.getElementById('btnNum365');
            let btnVol7 = document.getElementById('btnVol7');
            let btnVol30 = document.getElementById('btnVol30');
            let btnVol365 = document.getElementById('btnVol365');

            btnNum7.removeAttribute('disabled');
            btnNum30.removeAttribute('disabled');
            btnNum365.removeAttribute('disabled');
            btnVol7.removeAttribute('disabled');
            btnVol30.removeAttribute('disabled');
            btnVol365.removeAttribute('disabled');
        });
    </script>

    <!-- Script de pesquisa -->
    <script>
        let pesquisa = document.getElementById('pesquisa');
        
        function pesquisar() {
            let dadosPesquisa = {
                tabela: 'agencia',
                txt: pesquisa.value
            };

            ipcRenderer.send('pesquisar', dadosPesquisa);
        }
    </script>

    <!-- Script de funções da página -->
    <script>
        const dialog = require('electron').remote.dialog;
        const remote = require('electron').remote;

        function clickElement (element) {
            console.log(element);
            // Envia o evento 'trocarTelaDBA' para main.js
            ipcRenderer.send('trocarTelaDBA', element);
            console.log('Dados de troca de tela enviados!');
        }

        function selectAgencia(numero) {
            console.log('Clique na Agência ' + numero);
            ipcRenderer.send('requestFields', {
                tabela: 'agencia',
                campo: 'numero',
                id: numero
            });

            ipcRenderer.send('requestQuery', {
                query: '1.1',
                order: 'f.nome',
                id: numero
            });

            ipcRenderer.send('requestQuery', {
                query: '1.2',
                order: null,
                id: numero
            });

            ipcRenderer.send('requestQuery', {
                query: '1.3',
                order: null,
                id: numero
            });

            ipcRenderer.send('requestQuery', {
                query: '1.4',
                order: null,
                id: numero
            });

            ipcRenderer.send('requestQuery', {
                query: '1.5',
                order: '7',
                id: numero
            });

            console.log('Dados da Agência ' + numero + ' solicitados.');

            let botaoAtualizar = document.getElementById('atualizar');
            let botaoDeletar = document.getElementById('deletar');

            botaoAtualizar.setAttribute('onclick', 'onClickAtualizar(' + numero + ')');
            botaoDeletar.setAttribute('onclick', 'onClickDeletar(' + numero + ')');
        }

        function adicionarAgencia(){
            ipcRenderer.send('abrirTela', {
                tela: 'adicionarAgencia',
                tabela: 'agencia',
                campo: 'numero'
            });
        }

        function onClickAtualizar(id) {
            if (id == -1) {
                console.error('Nenhuma agência selecionada');
            }
            else {
                console.log('Agência Atualizada!');
            }
        }

        function onClickDeletar(id) {
            // Verifica se há alguma linha da tabela selecionada
            if (id == -1) {
                console.error('Nenhuma agência selecionada');
                dialog.showMessageBox(remote.getCurrentWindow(), {
                    type: 'error',
                    title: 'Erro ao Remover Agência',
                    message: 'Nenhuma agência selecionada!',
                    detail: 'Selecione uma agência antes de tentar remover.'
                });
            }   
            else {
                // Requisita confirmação do usuário sobre a deleção da tupla
                dialog.showMessageBox(remote.getCurrentWindow(), {
                    type: 'question',
                    buttons: ['Remover', 'Cancelar'],
                    defaultId: 0,
                    cancelId: 1,
                    title: 'Confirmar Remoção de Agência',
                    message: 'Você tem certeza que deseja remover a Agência ' + nome.value + '?',
                    detail: 'Essa ação não pode ser desfeita.\nTodos os dados dessa agência serão perdidos!'
                }, function (response) {
                    /* Se o usuário confirmar deleção, dados de tabela e id
                     * são enviados para main.js para tratar a deleção
                     */
                    if (!response) {
                        ipcRenderer.send('delete', {
                            tabela: 'agencia',
                            campo: 'numero',
                            id: id,
                            nome_tabela: 'Agência',
                            nome: nome.value,
                            detail: 'Podem haver funcionários e/ou contas associados a essa agência.'
                        });
                    }
                });
            }
        }

        let desconectar = document.getElementById('desconectar');
        let icon = document.getElementById('icon');

        desconectar.addEventListener('mouseleave', function () {
            icon.setAttribute('src', '../img/exit_to_app.png');
        });

        desconectar.addEventListener('mouseenter', function () {
            icon.setAttribute('src', '../img/exit_to_app_black.png');
        });

        function onClickDesconectar() {
            ipcRenderer.send('acessar', 'Carregando tela de login!');
        }

        function ordenar(campo) {
            let numero = document.getElementById('numero');
            ipcRenderer.send('requestQuery', {
                query: '1.1',
                order: campo,
                id: numero.value
            });
        }

        function onClickNumTrans(dias) {
            let numero = document.getElementById('numero');
            ipcRenderer.send('requestQuery', {
                query: '1.5',
                order: dias,
                id: numero.value
            });
        }
    </script>

    <!-- Querys -->
    <script>
        ipcRenderer.on('q1.1', function (event, fields) {
            console.log('Dados da query 1.1');
            console.log(fields);

            let div = document.getElementById('funcionario');
            let divHeader = document.createElement('div');
            let h5 = document.createElement('h5');
            let labelOrdenar = document.createElement('label');
            let divBotoes = document.createElement('div');
            let buttonNome = document.createElement('button');
            let buttonSalario = document.createElement('button');

            // Remove todos os elementos do corpo da tabela antes de inserir os novos
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }

            divHeader.setAttribute('class', 'form-row');
            h5.setAttribute('style', 'margin-right: 229px');
            h5.textContent = 'Funcionários';
            labelOrdenar.setAttribute('style', 'margin-right: 10px');
            labelOrdenar.textContent = 'Ordenar por:';
            divBotoes.setAttribute('class', 'btn-group btn-group-sm margin-bottom16');
            buttonNome.setAttribute('class', 'btn btn-info');
            buttonNome.setAttribute('onclick', 'ordenar("f.nome")');
            buttonNome.textContent = 'Nome';
            buttonSalario.setAttribute('class', 'btn btn-info');
            buttonSalario.setAttribute('onclick', 'ordenar("f.salario")');
            buttonSalario.textContent = 'Salário';

            divBotoes.appendChild(buttonNome);
            divBotoes.appendChild(buttonSalario);
            divHeader.appendChild(h5);
            divHeader.appendChild(labelOrdenar);
            divHeader.appendChild(divBotoes);
            div.appendChild(divHeader);

            if (fields.length == 0) {
                console.log('Funcionário sem dependente');
                let h6 = document.createElement('h6');
                h6.textContent = 'Não há dependentes para este funcionário.';
                div.appendChild(h6);
            }

            fields.forEach(element => {
                let divFuncionario = document.createElement('div');
                let div1 = document.createElement('div');
                let div2 = document.createElement('div');
                let div3 = document.createElement('div');
                let divNome = document.createElement('div');
                let divCargo = document.createElement('div');
                let divEndereco = document.createElement('div');
                let divCidade = document.createElement('div');
                let divSalario = document.createElement('div');
                let divSalario2 = document.createElement('div');
                let divNumDep = document.createElement('div');
                let labelNome = document.createElement('label');
                let labelCargo = document.createElement('label');
                let labelEndereco = document.createElement('label');
                let labelCidade = document.createElement('label');
                let labelSalario = document.createElement('label');
                let labelNumDep = document.createElement('label');
                let spanSalario = document.createElement('span');
                let inputNome = document.createElement('input');
                let inputCargo = document.createElement('input');
                let inputEndereco = document.createElement('input');
                let inputCidade = document.createElement('input');
                let inputSalario = document.createElement('input');
                let inputNumDep = document.createElement('input');

                divFuncionario.setAttribute('class', 'padding16 margin-bottom16 rounded border border-info');
                div1.setAttribute('class', 'form-row');
                div2.setAttribute('class', 'form-row');
                div3.setAttribute('class', 'form-row');
                divNome.setAttribute('class', 'form-group col-md-8');
                divCargo.setAttribute('class', 'form-group col-md-4');
                divEndereco.setAttribute('class', 'form-group col-md-8');
                divCidade.setAttribute('class', 'form-group col-md-4');
                divSalario.setAttribute('class', 'form-group col-md-5');
                divSalario2.setAttribute('class', 'input-group');
                divNumDep.setAttribute('class', 'form-group col-md-5');
                labelNome.textContent = 'Nome';
                labelCargo.textContent = 'Cargo';
                labelEndereco.textContent = 'Endereço';
                labelCidade.textContent = 'Cidade';
                labelSalario.textContent = 'Salário';
                labelNumDep.textContent = 'Número de Dependentes';
                spanSalario.setAttribute('class', 'input-group-addon');
                spanSalario.textContent = 'R$';
                inputNome.setAttribute('class', 'form-control');
                inputNome.setAttribute('disabled', null);
                inputCargo.setAttribute('class', 'form-control');
                inputCargo.setAttribute('disabled', null);
                inputEndereco.setAttribute('class', 'form-control');
                inputEndereco.setAttribute('disabled', null);
                inputCidade.setAttribute('class', 'form-control');
                inputCidade.setAttribute('disabled', null);
                inputSalario.setAttribute('class', 'form-control');
                inputSalario.setAttribute('disabled', null);
                inputNumDep.setAttribute('class', 'form-control');
                inputNumDep.setAttribute('disabled', null);
                inputNome.value = element.nome;
                inputCargo.value = element.cargo;
                inputEndereco.value = element.endereco;
                inputCidade.value = element.cidade;
                inputSalario.value = element.salario;
                inputNumDep.value = element.num_dependente;

                divSalario2.appendChild(spanSalario);
                divSalario2.appendChild(inputSalario);
                divSalario.appendChild(labelSalario);
                divSalario.appendChild(divSalario2);
                divNome.appendChild(labelNome);
                divNome.appendChild(inputNome);
                divCargo.appendChild(labelCargo);
                divCargo.appendChild(inputCargo);
                divEndereco.appendChild(labelEndereco);
                divEndereco.appendChild(inputEndereco);
                divCidade.appendChild(labelCidade);
                divCidade.appendChild(inputCidade);
                divNumDep.appendChild(labelNumDep);
                divNumDep.appendChild(inputNumDep);
                div1.appendChild(divNome);
                div1.appendChild(divCargo);
                div2.appendChild(divEndereco);
                div2.appendChild(divCidade);
                div3.appendChild(divSalario);
                div3.appendChild(divNumDep);
                divFuncionario.appendChild(div1);
                divFuncionario.appendChild(div2);
                divFuncionario.appendChild(div3);
                div.appendChild(divFuncionario);
            });
        });

        ipcRenderer.on('q1.2', function (event, fields) {
            console.log('Dados da query 1.2');
            console.log(fields);
            let tbody = document.getElementById('tabelaCliente');

            // Remove todos os elementos do corpo da tabela antes de inserir os novos
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            fields.forEach(element => {
                let tr = document.createElement('tr');
                let tdNome = document.createElement('td');
                let tdTipo = document.createElement('td');

                tdNome.textContent = element.nome_cliente;
                tdTipo.textContent = element.tipo_conta;

                switch (element.tipo_conta) {
                    case 'Conta Corrente':
                        tr.setAttribute('class', 'table-secondary');
                        break;
                    case 'Conta Poupança':
                        tr.setAttribute('class', 'table-warning');
                        break;
                    case 'Conta Especial':
                        tr.setAttribute('class', 'table-success');
                        break;
                }

                tr.appendChild(tdNome);
                tr.appendChild(tdTipo);
                tbody.appendChild(tr);
            });
        });

        ipcRenderer.on('q1.3', function (event, fields) {
            console.log('Dados da query 1.3');
            console.log(fields);
            let tbody = document.getElementById('tabelaContaEspecial');

            // Remove todos os elementos do corpo da tabela antes de inserir os novos
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            fields.forEach(element => {
                let tr = document.createElement('tr');
                let tdNumero = document.createElement('td');
                let tdSaldo = document.createElement('td');

                tdNumero.textContent = element.num_conta;
                tdSaldo.textContent = 'R$' + element.saldo;

                tr.appendChild(tdNumero);
                tr.appendChild(tdSaldo);
                tbody.appendChild(tr);
            });
        });

        ipcRenderer.on('q1.4', function (event, fields) {
            console.log('Dados da query 1.4');
            console.log(fields);
            let tbody = document.getElementById('tabelaContaPoupanca');

            // Remove todos os elementos do corpo da tabela antes de inserir os novos
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            fields.forEach(element => {
                let tr = document.createElement('tr');
                let tdNumero = document.createElement('td');
                let tdSaldo = document.createElement('td');

                tdNumero.textContent = element.num_conta;
                tdSaldo.textContent = 'R$' + element.saldo;

                tr.appendChild(tdNumero);
                tr.appendChild(tdSaldo);
                tbody.appendChild(tr);
            });
        });

        ipcRenderer.on('q1.5', function (event, fields) {
            console.log('Dados da query 1.4');
            console.log(fields);
            let tbody = document.getElementById('tabelaNumTransacao');

            // Remove todos os elementos do corpo da tabela antes de inserir os novos
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            fields.forEach(element => {
                let tr = document.createElement('tr');
                let tdNumConta = document.createElement('td');
                let tdNumTransacao = document.createElement('td');

                tdNumConta.textContent = element.num_conta;
                tdNumTransacao.textContent = element.num_transacoes;

                tr.appendChild(tdNumConta);
                tr.appendChild(tdNumTransacao);
                tbody.appendChild(tr);
            });
        });
    </script>
    
    <!-- Scripts para Bootstrap -->
    <script>let $ = require('../bootstrap/js/jquery-3.2.1.min.js');</script>
    <script src="../bootstrap/js/popper.min.js"></script>
    <script src="../bootstrap/js/bootstrap.js"></script>
</body>
</html>